/*
 * 
 * This tool is useful to extract the shellcode from objdump output
 * 
 * [TODO] check on shellcode buffer size if it is full to avoid stupid stack smashing 
 * 
 * */  

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>

#define SIZE 1000

int main(int argc , char* argv[])
{

FILE* f;
char out=' ';
char shellcode[SIZE] ={0};
int space=0,row=1;
int i=0,no=0;
int first=1;

if(argc<2)
    {
     printf("Error, usage is %s <file_name>",argv[0]);
     exit(0);
    }


f = fopen(argv[1],"r");

while(out!='0') // until 0 say to me that it is started the objdump data read and throw away 
	{out = fgetc(f);}

while(out!='Z'){

space=0;

out=fgetc(f);

while(out!=':')
	{
	 out = fgetc(f);
	 if(out=='<') //if I find a < that means I have to stop until another : to start memorize correct digits
	   {
		while(out!=':')	
			{out = fgetc(f);}
		out=fgetc(f);
	   }
	}

out=fgetc(f); //throw away the tab char

while(space<2)
   {
	out=fgetc(f);
	if(out!=' ' && first==1)
	  { 
		space=0;
		shellcode[i]='\\';
        i++;
        shellcode[i]='x';
        i++;
        shellcode[i]=out;
        i++;  
        first=0;
	  }
	else
	   { 
		if(out!=' ' && first==0)
		  {
			shellcode[i]=out;
			i++;  
			first=1;
		  }
		else
			{
			space++;  
			}
		}
   } //end while space
   
while(out!=10 && out!='Z')
	{out = fgetc(f);}

} //end while feof

printf("\n\n%s\n\n",shellcode);
fclose(f);


} //end main
